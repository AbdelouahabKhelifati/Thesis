CREATE EXTENSION IF NOT EXISTS plpythonu;
CREATE EXTENSION IF NOT EXISTS timescaledb CASCADE;

DROP TYPE IF EXISTS datapoint CASCADE;
DROP TYPE IF EXISTS result_type CASCADE;

CREATE TYPE datapoint AS ( time TIMESTAMP WITHOUT TIME ZONE, d DOUBLE PRECISION ARRAY);
CREATE TYPE result_type AS ( time TIMESTAMP WITHOUT TIME ZONE, d DOUBLE PRECISION ARRAY );

CREATE TABLE datapoints OF datapoint;
CREATE TABLE zscore OF result_type;
SELECT create_hypertable('datapoints', 'time');

DO $load_data$
DECLARE
	start_time TIMESTAMP WITH TIME ZONE;
	end_time TIMESTAMP WITH TIME ZONE;
	delta DOUBLE PRECISION;
	initial_size DOUBLE PRECISION;
	final_size DOUBLE PRECISION;
BEGIN
	start_time := clock_timestamp();
	COPY datapoints FROM '/home/gabi/Thesis-master/Datasets/synthetic.txt.csv' DELIMITER ',' CSV;
	end_time := clock_timestamp();
END;
$load_data$;

DO $zscore$
DECLARE
	start_time TIMESTAMP WITH TIME ZONE;
	end_time TIMESTAMP WITH TIME ZONE;
	delta DOUBLE PRECISION;
BEGIN
	start_time := clock_timestamp();
	INSERT INTO zscore
	SELECT time, array[
(d[1] - (select avg(d[1]) from datapoints)) / (select stddev_pop(d[1]) from datapoints),	(d[2] - (select avg(d[2]) from datapoints)) / (select stddev_pop(d[2]) from datapoints),	(d[3] - (select avg(d[3]) from datapoints)) / (select stddev_pop(d[3]) from datapoints),	(d[4] - (select avg(d[4]) from datapoints)) / (select stddev_pop(d[4]) from datapoints),	(d[5] - (select avg(d[5]) from datapoints)) / (select stddev_pop(d[5]) from datapoints),	(d[6] - (select avg(d[6]) from datapoints)) / (select stddev_pop(d[6]) from datapoints),	(d[7] - (select avg(d[7]) from datapoints)) / (select stddev_pop(d[7]) from datapoints),	(d[8] - (select avg(d[8]) from datapoints)) / (select stddev_pop(d[8]) from datapoints),	(d[9] - (select avg(d[9]) from datapoints)) / (select stddev_pop(d[9]) from datapoints),	(d[10] - (select avg(d[10]) from datapoints)) / (select stddev_pop(d[10]) from datapoints),	(d[11] - (select avg(d[11]) from datapoints)) / (select stddev_pop(d[11]) from datapoints),	(d[12] - (select avg(d[12]) from datapoints)) / (select stddev_pop(d[12]) from datapoints),	(d[13] - (select avg(d[13]) from datapoints)) / (select stddev_pop(d[13]) from datapoints),	(d[14] - (select avg(d[14]) from datapoints)) / (select stddev_pop(d[14]) from datapoints),	(d[15] - (select avg(d[15]) from datapoints)) / (select stddev_pop(d[15]) from datapoints),	(d[16] - (select avg(d[16]) from datapoints)) / (select stddev_pop(d[16]) from datapoints),	(d[17] - (select avg(d[17]) from datapoints)) / (select stddev_pop(d[17]) from datapoints),	(d[18] - (select avg(d[18]) from datapoints)) / (select stddev_pop(d[18]) from datapoints),	(d[19] - (select avg(d[19]) from datapoints)) / (select stddev_pop(d[19]) from datapoints),	(d[20] - (select avg(d[20]) from datapoints)) / (select stddev_pop(d[20]) from datapoints),	(d[21] - (select avg(d[21]) from datapoints)) / (select stddev_pop(d[21]) from datapoints),	(d[22] - (select avg(d[22]) from datapoints)) / (select stddev_pop(d[22]) from datapoints),	(d[23] - (select avg(d[23]) from datapoints)) / (select stddev_pop(d[23]) from datapoints),	(d[24] - (select avg(d[24]) from datapoints)) / (select stddev_pop(d[24]) from datapoints),	(d[25] - (select avg(d[25]) from datapoints)) / (select stddev_pop(d[25]) from datapoints),	(d[26] - (select avg(d[26]) from datapoints)) / (select stddev_pop(d[26]) from datapoints),	(d[27] - (select avg(d[27]) from datapoints)) / (select stddev_pop(d[27]) from datapoints),	(d[28] - (select avg(d[28]) from datapoints)) / (select stddev_pop(d[28]) from datapoints),	(d[29] - (select avg(d[29]) from datapoints)) / (select stddev_pop(d[29]) from datapoints),	(d[30] - (select avg(d[30]) from datapoints)) / (select stddev_pop(d[30]) from datapoints),	(d[31] - (select avg(d[31]) from datapoints)) / (select stddev_pop(d[31]) from datapoints),	(d[32] - (select avg(d[32]) from datapoints)) / (select stddev_pop(d[32]) from datapoints),	(d[33] - (select avg(d[33]) from datapoints)) / (select stddev_pop(d[33]) from datapoints),	(d[34] - (select avg(d[34]) from datapoints)) / (select stddev_pop(d[34]) from datapoints),	(d[35] - (select avg(d[35]) from datapoints)) / (select stddev_pop(d[35]) from datapoints),	(d[36] - (select avg(d[36]) from datapoints)) / (select stddev_pop(d[36]) from datapoints),	(d[37] - (select avg(d[37]) from datapoints)) / (select stddev_pop(d[37]) from datapoints),	(d[38] - (select avg(d[38]) from datapoints)) / (select stddev_pop(d[38]) from datapoints),	(d[39] - (select avg(d[39]) from datapoints)) / (select stddev_pop(d[39]) from datapoints),	(d[40] - (select avg(d[40]) from datapoints)) / (select stddev_pop(d[40]) from datapoints),	(d[41] - (select avg(d[41]) from datapoints)) / (select stddev_pop(d[41]) from datapoints),	(d[42] - (select avg(d[42]) from datapoints)) / (select stddev_pop(d[42]) from datapoints),	(d[43] - (select avg(d[43]) from datapoints)) / (select stddev_pop(d[43]) from datapoints),	(d[44] - (select avg(d[44]) from datapoints)) / (select stddev_pop(d[44]) from datapoints),	(d[45] - (select avg(d[45]) from datapoints)) / (select stddev_pop(d[45]) from datapoints),	(d[46] - (select avg(d[46]) from datapoints)) / (select stddev_pop(d[46]) from datapoints),	(d[47] - (select avg(d[47]) from datapoints)) / (select stddev_pop(d[47]) from datapoints),	(d[48] - (select avg(d[48]) from datapoints)) / (select stddev_pop(d[48]) from datapoints),	(d[49] - (select avg(d[49]) from datapoints)) / (select stddev_pop(d[49]) from datapoints),	(d[50] - (select avg(d[50]) from datapoints)) / (select stddev_pop(d[50]) from datapoints),	(d[51] - (select avg(d[51]) from datapoints)) / (select stddev_pop(d[51]) from datapoints),	(d[52] - (select avg(d[52]) from datapoints)) / (select stddev_pop(d[52]) from datapoints),	(d[53] - (select avg(d[53]) from datapoints)) / (select stddev_pop(d[53]) from datapoints),	(d[54] - (select avg(d[54]) from datapoints)) / (select stddev_pop(d[54]) from datapoints),	(d[55] - (select avg(d[55]) from datapoints)) / (select stddev_pop(d[55]) from datapoints),	(d[56] - (select avg(d[56]) from datapoints)) / (select stddev_pop(d[56]) from datapoints),	(d[57] - (select avg(d[57]) from datapoints)) / (select stddev_pop(d[57]) from datapoints),	(d[58] - (select avg(d[58]) from datapoints)) / (select stddev_pop(d[58]) from datapoints),	(d[59] - (select avg(d[59]) from datapoints)) / (select stddev_pop(d[59]) from datapoints),	(d[60] - (select avg(d[60]) from datapoints)) / (select stddev_pop(d[60]) from datapoints),	(d[61] - (select avg(d[61]) from datapoints)) / (select stddev_pop(d[61]) from datapoints),	(d[62] - (select avg(d[62]) from datapoints)) / (select stddev_pop(d[62]) from datapoints),	(d[63] - (select avg(d[63]) from datapoints)) / (select stddev_pop(d[63]) from datapoints),	(d[64] - (select avg(d[64]) from datapoints)) / (select stddev_pop(d[64]) from datapoints),	(d[65] - (select avg(d[65]) from datapoints)) / (select stddev_pop(d[65]) from datapoints),	(d[66] - (select avg(d[66]) from datapoints)) / (select stddev_pop(d[66]) from datapoints),	(d[67] - (select avg(d[67]) from datapoints)) / (select stddev_pop(d[67]) from datapoints),	(d[68] - (select avg(d[68]) from datapoints)) / (select stddev_pop(d[68]) from datapoints),	(d[69] - (select avg(d[69]) from datapoints)) / (select stddev_pop(d[69]) from datapoints),	(d[70] - (select avg(d[70]) from datapoints)) / (select stddev_pop(d[70]) from datapoints),	(d[71] - (select avg(d[71]) from datapoints)) / (select stddev_pop(d[71]) from datapoints),	(d[72] - (select avg(d[72]) from datapoints)) / (select stddev_pop(d[72]) from datapoints),	(d[73] - (select avg(d[73]) from datapoints)) / (select stddev_pop(d[73]) from datapoints),	(d[74] - (select avg(d[74]) from datapoints)) / (select stddev_pop(d[74]) from datapoints),	(d[75] - (select avg(d[75]) from datapoints)) / (select stddev_pop(d[75]) from datapoints),	(d[76] - (select avg(d[76]) from datapoints)) / (select stddev_pop(d[76]) from datapoints),	(d[77] - (select avg(d[77]) from datapoints)) / (select stddev_pop(d[77]) from datapoints),	(d[78] - (select avg(d[78]) from datapoints)) / (select stddev_pop(d[78]) from datapoints),	(d[79] - (select avg(d[79]) from datapoints)) / (select stddev_pop(d[79]) from datapoints),	(d[80] - (select avg(d[80]) from datapoints)) / (select stddev_pop(d[80]) from datapoints),	(d[81] - (select avg(d[81]) from datapoints)) / (select stddev_pop(d[81]) from datapoints),	(d[82] - (select avg(d[82]) from datapoints)) / (select stddev_pop(d[82]) from datapoints),	(d[83] - (select avg(d[83]) from datapoints)) / (select stddev_pop(d[83]) from datapoints),	(d[84] - (select avg(d[84]) from datapoints)) / (select stddev_pop(d[84]) from datapoints),	(d[85] - (select avg(d[85]) from datapoints)) / (select stddev_pop(d[85]) from datapoints),	(d[86] - (select avg(d[86]) from datapoints)) / (select stddev_pop(d[86]) from datapoints),	(d[87] - (select avg(d[87]) from datapoints)) / (select stddev_pop(d[87]) from datapoints),	(d[88] - (select avg(d[88]) from datapoints)) / (select stddev_pop(d[88]) from datapoints),	(d[89] - (select avg(d[89]) from datapoints)) / (select stddev_pop(d[89]) from datapoints),	(d[90] - (select avg(d[90]) from datapoints)) / (select stddev_pop(d[90]) from datapoints),	(d[91] - (select avg(d[91]) from datapoints)) / (select stddev_pop(d[91]) from datapoints),	(d[92] - (select avg(d[92]) from datapoints)) / (select stddev_pop(d[92]) from datapoints),	(d[93] - (select avg(d[93]) from datapoints)) / (select stddev_pop(d[93]) from datapoints),	(d[94] - (select avg(d[94]) from datapoints)) / (select stddev_pop(d[94]) from datapoints),	(d[95] - (select avg(d[95]) from datapoints)) / (select stddev_pop(d[95]) from datapoints),	(d[96] - (select avg(d[96]) from datapoints)) / (select stddev_pop(d[96]) from datapoints),	(d[97] - (select avg(d[97]) from datapoints)) / (select stddev_pop(d[97]) from datapoints),	(d[98] - (select avg(d[98]) from datapoints)) / (select stddev_pop(d[98]) from datapoints),	(d[99] - (select avg(d[99]) from datapoints)) / (select stddev_pop(d[99]) from datapoints),	(d[100] - (select avg(d[100]) from datapoints)) / (select stddev_pop(d[100]) from datapoints)
	]
	FROM datapoints;
	end_time := clock_timestamp();
	delta = extract(epoch from end_time) - extract(epoch from start_time);

	RAISE NOTICE 'Z-Score time seconds = %', delta;
END;
$zscore$;

--select * from datapoints;
--select * from zscore;
